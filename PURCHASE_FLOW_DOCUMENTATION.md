# Purchase Flow Documentation

## Overview
Complete e-commerce purchase flow system for Bimble Farmasi services allowing users to browse programs, place orders, make payments, and track order status.

## Features Implemented

### 1. **Order Management System**
- **OrderController** with 6 methods:
  - `create($slug)` - Display program details and order form
  - `store()` - Create new order
  - `payment($orderNumber)` - Show payment page with method selection
  - `processPayment()` - Handle payment proof upload
  - `success($orderNumber)` - Display order success confirmation
  - `myOrders()` - List all user orders

### 2. **Database Schema**
- **programs** table:
  - Stores service packages (UKOM, CPNS, Joki Tugas)
  - Fields: name, slug, type, description, features (JSON), price, duration_months, total_sessions, is_active
  
- **orders** table:
  - Stores user purchase orders
  - Fields: order_number (auto-generated), user_id, program_id, amount, status, notes
  - Relationships: belongsTo(User, Program), hasOne(Payment)
  
- **payments** table:
  - Tracks payment details and proof
  - Fields: order_id, payment_method, amount, status, proof_url, paid_at, notes
  - Status: pending, paid, rejected
  - Payment methods: bank_transfer, ewallet, qris

### 3. **Protected Routes**
All order routes require authentication (`auth` middleware):
```php
GET    /order/{slug}                    → order.create          (Order form)
POST   /order                           → order.store           (Create order)
GET    /order/{orderNumber}/payment    → order.payment         (Payment page)
POST   /order/{orderNumber}/payment    → order.payment.process (Upload proof)
GET    /order/{orderNumber}/success    → order.success         (Success page)
GET    /pesanan-saya                   → order.my-orders       (My orders list)
```

### 4. **Views Created**
- `pages/order/create.blade.php` - Order form with program details
- `pages/order/payment.blade.php` - Payment method selection & proof upload
- `pages/order/success.blade.php` - Order confirmation page
- `pages/order/my-orders.blade.php` - User's order history

### 5. **Updated Components**
- **Navigation**: Added "Pesanan Saya" to profile dropdown menu (desktop & mobile)
- **Service Pages**: Changed all "Hubungi Kami" buttons to "Beli Sekarang"
  - `bimbel-ukom.blade.php` → Links to `/order/bimbel-ukom-d3-farmasi`
  - `cpns-p3k.blade.php` → Links to `/order/cpns-p3k-farmasi`
  - `joki-tugas.blade.php` → Links to `/order/joki-tugas-farmasi`

### 6. **Data Seeding**
**ProgramSeeder** creates 3 programs:
1. **Bimbel UKOM D3 Farmasi** - Rp 1.250.000
   - 3 months, 24 sessions
   - Features: Try out, video, bank soal, etc.

2. **CPNS & P3K Farmasi** - Rp 2.050.000
   - 4 months, 32 sessions
   - Features: TWK/TIU/TKP, CAT simulation, etc.

3. **Joki Tugas Farmasi** - Rp 500.000
   - 1 month, 1 session
   - Features: Plagiarism check, unlimited revisions, etc.

## User Flow

### Purchase Flow
1. **Browse** → User visits service detail page (bimbel-ukom, cpns-p3k, joki-tugas)
2. **Click** → "Beli Sekarang" button redirects to `/order/{slug}` (requires login)
3. **Order Form** → User reviews program details, adds optional notes, clicks "Lanjut ke Pembayaran"
4. **Payment Method** → User selects payment method (Bank Transfer, E-Wallet, or QRIS)
5. **Upload Proof** → User uploads payment proof (PNG/JPG max 2MB)
6. **Success** → Order created with status "pending", payment awaiting verification
7. **My Orders** → User can track order status at `/pesanan-saya`

### Order Status Flow
```
1. Order Created → status: "pending" (no payment record)
2. Payment Uploaded → payment.status: "pending" (awaiting admin verification)
3. Admin Verifies → payment.status: "paid" (user can access service)
4. Admin Rejects → payment.status: "rejected" (user can re-upload)
```

## Payment Methods
- **Bank Transfer**: BCA, Mandiri (account numbers displayed)
- **E-Wallet**: GoPay, OVO, DANA, ShopeePay (phone number displayed)
- **QRIS**: QR Code displayed for scanning

## File Storage
- Payment proofs stored in: `storage/app/public/payment-proofs/`
- Accessible via: `public/storage/payment-proofs/` (symlink created)
- Command: `php artisan storage:link`

## Validation Rules
### Order Creation
- `program_id`: required, must exist in programs table
- `notes`: optional, max 500 characters

### Payment Processing
- `payment_method`: required, must be bank_transfer|ewallet|qris
- `proof`: required, must be image, max 2MB

## Order Number Format
Auto-generated with pattern: `ORD-YYYYMMDD-RANDOM6`
- Example: `ORD-20251006-ABC123`
- Generated by: `Order::generateOrderNumber()`

## Admin Integration Points
For admin panel, implement these features:
1. **Payment Verification**
   - List all payments with status "pending"
   - View uploaded proof image
   - Approve (set status to "paid") or Reject (set status to "rejected")
   - Send email notification to user

2. **Order Management**
   - View all orders with filters (status, date, program)
   - Export order data to Excel/PDF
   - View order statistics (total revenue, orders by program, etc.)

3. **Service Activation**
   - When payment status = "paid", activate user access to program
   - Update `my-services` page with enrolled programs
   - Send welcome email with access instructions

## Future Enhancements
- [ ] Payment gateway integration (Midtrans, Xendit)
- [ ] Automatic payment verification via API
- [ ] Invoice generation (PDF download)
- [ ] Email notifications for order status changes
- [ ] Promo code / discount system
- [ ] Installment payment options
- [ ] Order cancellation feature
- [ ] Review & rating system for completed orders

## Testing Checklist
- [x] Programs seeded in database
- [x] Order routes protected with auth middleware
- [x] Order form displays program details correctly
- [x] Payment page shows selected payment methods
- [x] File upload validation (image, 2MB max)
- [x] Storage symlink created
- [x] Success page displays order summary
- [x] My Orders page lists all user orders
- [x] Navigation menu includes "Pesanan Saya"
- [x] Service pages redirect to order page

## Database Commands
```bash
# Run migrations
php artisan migrate

# Seed programs
php artisan db:seed --class=ProgramSeeder

# Create storage symlink
php artisan storage:link
```

## Related Files
**Controllers:**
- `app/Http/Controllers/OrderController.php`

**Models:**
- `app/Models/Program.php`
- `app/Models/Order.php`
- `app/Models/Payment.php`

**Migrations:**
- `database/migrations/2025_10_06_084007_create_programs_table.php`
- `database/migrations/2025_10_06_084014_create_orders_table.php`
- `database/migrations/2025_10_06_084015_create_payments_table.php`

**Seeders:**
- `database/seeders/ProgramSeeder.php`

**Views:**
- `resources/views/pages/order/create.blade.php`
- `resources/views/pages/order/payment.blade.php`
- `resources/views/pages/order/success.blade.php`
- `resources/views/pages/order/my-orders.blade.php`

**Routes:**
- `routes/web.php` (lines with OrderController)
